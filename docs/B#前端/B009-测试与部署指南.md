# 测试与部署指南

## 📋 概述

本文档提供了前端项目的测试和部署完整指南，包括单元测试、集成测试、构建优化和部署流程。

## 🧪 测试

### 测试框架

- **Jest**: 测试运行器和断言库
- **React Testing Library**: React 组件测试
- **@testing-library/user-event**: 用户交互模拟

### 运行测试

```bash
# 运行所有测试
npm test

# 运行测试并生成覆盖率报告
npm run test:coverage

# CI 环境运行测试
npm run test:ci

# 使用脚本运行测试
./scripts/test.sh                # 单次运行
./scripts/test.sh --watch        # 监听模式
./scripts/test.sh --coverage     # 生成覆盖率
./scripts/test.sh --update       # 更新快照
```

### 测试文件组织

```
src/
├── components/
│   └── common/
│       ├── Button.tsx
│       └── __tests__/
│           └── Button.test.tsx
├── hooks/
│   ├── useDebounce.ts
│   └── __tests__/
│       └── useDebounce.test.ts
├── pages/
│   └── home/
│       ├── HomePage.tsx
│       └── __tests__/
│           └── HomePage.test.tsx
└── utils/
    ├── promptFormatter.ts
    └── __tests__/
        └── promptFormatter.test.ts
```

### 测试覆盖率目标

| 类型 | 目标 | 当前 |
|------|------|------|
| 语句覆盖率 | 40% | - |
| 分支覆盖率 | 40% | - |
| 函数覆盖率 | 40% | - |
| 行覆盖率 | 40% | - |

### 编写测试示例

#### 组件测试

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import Button from '../Button';

test('按钮点击事件', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>点击</Button>);

    fireEvent.click(screen.getByText('点击'));
    expect(handleClick).toHaveBeenCalledTimes(1);
});
```

#### Hook 测试

```typescript
import { renderHook, act } from '@testing-library/react';
import { useDebounce } from '../useDebounce';

test('防抖功能', () => {
    jest.useFakeTimers();
    const { result, rerender } = renderHook(
        ({ value }) => useDebounce(value, 500),
        { initialProps: { value: 'initial' } }
    );

    rerender({ value: 'updated' });
    act(() => jest.advanceTimersByTime(500));

    expect(result.current).toBe('updated');
    jest.useRealTimers();
});
```

#### 工具函数测试

```typescript
import { formatPromptToMarkdown } from '../promptFormatter';

test('格式化为 Markdown', () => {
    const data = {
        taskGoal: '测试任务',
        aiRole: '测试角色',
        // ...
    };

    const result = formatPromptToMarkdown(data);
    expect(result).toContain('# 任务目标');
    expect(result).toContain('测试任务');
});
```

## 🏗️ 构建

### 开发构建

```bash
# 启动开发服务器
npm run dev

# 启动开发服务器（指定端口）
npm run start:3100
```

### 生产构建

```bash
# 构建生产版本
npm run build

# 使用脚本构建（包含检查）
./scripts/build.sh
```

### 构建优化

#### 代码分割

项目使用 React.lazy 和 Suspense 实现代码分割：

```typescript
const HomePage = React.lazy(() => import('./pages/home/HomePage'));
const TemplatesPage = React.lazy(() => import('./pages/templates/TemplatesPage'));
```

#### 资源优化

- **图片优化**: 使用 WebP 格式，压缩图片
- **字体优化**: 使用 font-display: swap
- **CSS 优化**: 使用 PurgeCSS 移除未使用的样式

#### 构建分析

```bash
# 分析构建产物
npm run analyze
```

### 环境变量

#### 开发环境 (.env.development)

```env
REACT_APP_API_BASE_URL=http://localhost:8080/api
PORT=3100
BROWSER=none
```

#### 生产环境 (.env.production)

```env
REACT_APP_API_BASE_URL=/api
GENERATE_SOURCEMAP=false
```

## 🚀 部署

### Docker 部署

#### 构建镜像

```bash
# 构建 Docker 镜像
docker build -t cese-kiro:latest .

# 使用 docker-compose 构建
docker-compose build
```

#### 运行容器

```bash
# 使用 docker-compose 运行
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止容器
docker-compose down
```

### 手动部署

#### 使用部署脚本

```bash
# 部署到生产环境
./scripts/deploy.sh production

# 部署到开发环境
./scripts/deploy.sh development

# 部署到预发布环境
./scripts/deploy.sh staging
```

#### 部署流程

1. **拉取代码**: `git pull origin main`
2. **安装依赖**: `npm ci`
3. **运行测试**: `npm run test:ci`
4. **代码检查**: `npm run check`
5. **构建项目**: `npm run build`
6. **构建镜像**: `docker build`
7. **启动服务**: `docker-compose up -d`
8. **健康检查**: 验证服务可访问

### Nginx 配置

项目使用 Nginx 作为 Web 服务器，配置文件 `nginx.conf` 包含：

- **Gzip 压缩**: 压缩静态资源
- **缓存策略**: 静态资源长期缓存
- **SPA 路由**: 支持前端路由
- **API 代理**: 代理后端 API 请求
- **安全头**: 添加安全相关的 HTTP 头

### CI/CD 流程

#### GitHub Actions

项目使用 GitHub Actions 实现自动化 CI/CD：

```yaml
# .github/workflows/ci.yml
- 代码检查 (Lint)
- 类型检查 (Type Check)
- 格式检查 (Format Check)
- 运行测试 (Test)
- 上传覆盖率 (Coverage)
- 构建项目 (Build)
- 构建镜像 (Docker Build)
- 推送镜像 (Docker Push)
```

#### 触发条件

- **Push**: main 和 develop 分支
- **Pull Request**: main 和 develop 分支

#### 环境要求

需要在 GitHub Secrets 中配置：

- `DOCKER_USERNAME`: Docker Hub 用户名
- `DOCKER_PASSWORD`: Docker Hub 密码

## 📊 性能优化

### 代码优化

- ✅ 使用 React.memo 避免不必要的重渲染
- ✅ 使用 useMemo 和 useCallback 优化计算
- ✅ 使用防抖和节流优化频繁操作
- ✅ 使用虚拟滚动处理大列表

### 资源优化

- ✅ 代码分割和懒加载
- ✅ 图片懒加载
- ✅ 字体优化
- ✅ CSS 优化

### 网络优化

- ✅ HTTP/2 支持
- ✅ Gzip 压缩
- ✅ 资源缓存
- ✅ CDN 加速（可选）

## 🔍 监控与日志

### 性能监控

使用 Web Vitals 监控核心性能指标：

```typescript
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

getCLS(console.log);
getFID(console.log);
getFCP(console.log);
getLCP(console.log);
getTTFB(console.log);
```

### 错误监控

使用 ErrorBoundary 捕获 React 错误：

```typescript
<ErrorBoundary>
    <App />
</ErrorBoundary>
```

### 日志收集

可选集成第三方服务：

- **Sentry**: 错误追踪
- **Google Analytics**: 用户行为分析
- **LogRocket**: 会话回放

## 🛠️ 故障排查

### 常见问题

#### 构建失败

```bash
# 清理缓存
rm -rf node_modules package-lock.json
npm install

# 清理构建产物
rm -rf build
npm run build
```

#### 测试失败

```bash
# 更新快照
npm test -- --updateSnapshot

# 清理测试缓存
npm test -- --clearCache
```

#### Docker 问题

```bash
# 查看容器日志
docker-compose logs -f

# 重新构建镜像
docker-compose build --no-cache

# 清理 Docker 资源
docker system prune -a
```

## 📝 检查清单

### 部署前检查

- [ ] 所有测试通过
- [ ] 代码检查通过
- [ ] 类型检查通过
- [ ] 格式检查通过
- [ ] 构建成功
- [ ] 环境变量配置正确
- [ ] API 地址配置正确
- [ ] 备份数据库（如有）

### 部署后检查

- [ ] 应用可正常访问
- [ ] 所有页面正常加载
- [ ] API 请求正常
- [ ] 用户认证功能正常
- [ ] 核心功能正常
- [ ] 性能指标正常
- [ ] 错误日志正常

## 🎯 最佳实践

### 测试最佳实践

1. **测试用户行为而非实现细节**
2. **保持测试简单和专注**
3. **使用有意义的测试描述**
4. **避免测试第三方库**
5. **保持测试独立性**

### 部署最佳实践

1. **使用环境变量管理配置**
2. **实施蓝绿部署或滚动更新**
3. **保持部署脚本幂等性**
4. **实施健康检查**
5. **保留回滚能力**

### 性能最佳实践

1. **监控核心性能指标**
2. **定期进行性能审计**
3. **优化关键渲染路径**
4. **减少包体积**
5. **使用 CDN 加速静态资源**

---

**文档版本**: 1.0.0
**最后更新**: 2024年
**维护者**: 前端开发团队
